
<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>MLlib Linear Algebra Acceleration Guide - Spark 3.0.2 Documentation</title>
        

        

        <link rel="stylesheet" href="css/bootstrap.min.css">
        <style>
            body {
                padding-top: 60px;
                padding-bottom: 40px;
            }
        </style>
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="css/bootstrap-responsive.min.css">
        <link rel="stylesheet" href="css/main.css">

        <script src="js/vendor/modernizr-2.6.1-respond-1.1.0.min.js"></script>

        <link rel="stylesheet" href="css/pygments-default.css">

        
        <!-- Google analytics script -->
        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-32518208-2']);
          _gaq.push(['_trackPageview']);

          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
        </script>
        

    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="https://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->

        <!-- This code is taken from http://twitter.github.com/bootstrap/examples/hero.html -->

        <div class="navbar navbar-fixed-top" id="topbar">
            <div class="navbar-inner">
                <div class="container">
                    <div class="brand"><a href="index.html">
                      <img src="img/spark-logo-hd.png" style="height:50px;"/></a><span class="version">3.0.2</span>
                    </div>
                    <ul class="nav">
                        <!--TODO(andyk): Add class="active" attribute to li some how.-->
                        <li><a href="index.html">Overview</a></li>

                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Programming Guides<b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="quick-start.html">Quick Start</a></li>
                                <li><a href="rdd-programming-guide.html">RDDs, Accumulators, Broadcasts Vars</a></li>
                                <li><a href="sql-programming-guide.html">SQL, DataFrames, and Datasets</a></li>
                                <li><a href="structured-streaming-programming-guide.html">Structured Streaming</a></li>
                                <li><a href="streaming-programming-guide.html">Spark Streaming (DStreams)</a></li>
                                <li><a href="ml-guide.html">MLlib (Machine Learning)</a></li>
                                <li><a href="graphx-programming-guide.html">GraphX (Graph Processing)</a></li>
                                <li><a href="sparkr.html">SparkR (R on Spark)</a></li>
                            </ul>
                        </li>

                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">API Docs<b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="api/scala/org/apache/spark/index.html">Scala</a></li>
                                <li><a href="api/java/index.html">Java</a></li>
                                <li><a href="api/python/index.html">Python</a></li>
                                <li><a href="api/R/index.html">R</a></li>
                                <li><a href="api/sql/index.html">SQL, Built-in Functions</a></li>
                            </ul>
                        </li>

                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Deploying<b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="cluster-overview.html">Overview</a></li>
                                <li><a href="submitting-applications.html">Submitting Applications</a></li>
                                <li class="divider"></li>
                                <li><a href="spark-standalone.html">Spark Standalone</a></li>
                                <li><a href="running-on-mesos.html">Mesos</a></li>
                                <li><a href="running-on-yarn.html">YARN</a></li>
                                <li><a href="running-on-kubernetes.html">Kubernetes</a></li>
                            </ul>
                        </li>

                        <li class="dropdown">
                            <a href="api.html" class="dropdown-toggle" data-toggle="dropdown">More<b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="configuration.html">Configuration</a></li>
                                <li><a href="monitoring.html">Monitoring</a></li>
                                <li><a href="tuning.html">Tuning Guide</a></li>
                                <li><a href="job-scheduling.html">Job Scheduling</a></li>
                                <li><a href="security.html">Security</a></li>
                                <li><a href="hardware-provisioning.html">Hardware Provisioning</a></li>
                                <li><a href="migration-guide.html">Migration Guide</a></li>
                                <li class="divider"></li>
                                <li><a href="building-spark.html">Building Spark</a></li>
                                <li><a href="https://spark.apache.org/contributing.html">Contributing to Spark</a></li>
                                <li><a href="https://spark.apache.org/third-party-projects.html">Third Party Projects</a></li>
                            </ul>
                        </li>
                    </ul>
                    <!--<p class="navbar-text pull-right"><span class="version-text">v3.0.2</span></p>-->
                </div>
            </div>
        </div>

        <div class="container-wrapper">

            
                
                    <div class="left-menu-wrapper">
    <div class="left-menu">
        <h3><a href="ml-guide.html">MLlib: Main Guide</a></h3>
        
<ul>

    <li>
        <a href="ml-statistics.html">
            
                Basic statistics
            
        </a>
    </li>
    
    

    <li>
        <a href="ml-datasource.html">
            
                Data sources
            
        </a>
    </li>
    
    

    <li>
        <a href="ml-pipeline.html">
            
                Pipelines
            
        </a>
    </li>
    
    

    <li>
        <a href="ml-features.html">
            
                Extracting, transforming and selecting features
            
        </a>
    </li>
    
    

    <li>
        <a href="ml-classification-regression.html">
            
                Classification and Regression
            
        </a>
    </li>
    
    

    <li>
        <a href="ml-clustering.html">
            
                Clustering
            
        </a>
    </li>
    
    

    <li>
        <a href="ml-collaborative-filtering.html">
            
                Collaborative filtering
            
        </a>
    </li>
    
    

    <li>
        <a href="ml-frequent-pattern-mining.html">
            
                Frequent Pattern Mining
            
        </a>
    </li>
    
    

    <li>
        <a href="ml-tuning.html">
            
                Model selection and tuning
            
        </a>
    </li>
    
    

    <li>
        <a href="ml-advanced.html">
            
                Advanced topics
            
        </a>
    </li>
    
    

</ul>

        <h3><a href="mllib-guide.html">MLlib: RDD-based API Guide</a></h3>
        
<ul>

    <li>
        <a href="mllib-data-types.html">
            
                Data types
            
        </a>
    </li>
    
    

    <li>
        <a href="mllib-statistics.html">
            
                Basic statistics
            
        </a>
    </li>
    
    

    <li>
        <a href="mllib-classification-regression.html">
            
                Classification and regression
            
        </a>
    </li>
    
    

    <li>
        <a href="mllib-collaborative-filtering.html">
            
                Collaborative filtering
            
        </a>
    </li>
    
    

    <li>
        <a href="mllib-clustering.html">
            
                Clustering
            
        </a>
    </li>
    
    

    <li>
        <a href="mllib-dimensionality-reduction.html">
            
                Dimensionality reduction
            
        </a>
    </li>
    
    

    <li>
        <a href="mllib-feature-extraction.html">
            
                Feature extraction and transformation
            
        </a>
    </li>
    
    

    <li>
        <a href="mllib-frequent-pattern-mining.html">
            
                Frequent pattern mining
            
        </a>
    </li>
    
    

    <li>
        <a href="mllib-evaluation-metrics.html">
            
                Evaluation metrics
            
        </a>
    </li>
    
    

    <li>
        <a href="mllib-pmml-model-export.html">
            
                PMML model export
            
        </a>
    </li>
    
    

    <li>
        <a href="mllib-optimization.html">
            
                Optimization (developer)
            
        </a>
    </li>
    
    

</ul>

    </div>
</div>
                
                <input id="nav-trigger" class="nav-trigger" checked type="checkbox">
                <label for="nav-trigger"></label>
                <div class="content-with-sidebar" id="content">
                    
                        <h1 class="title">MLlib Linear Algebra Acceleration Guide</h1>
                    

                    <h2 id="introduction">Introduction</h2>

<p>This guide provides necessary information to enable accelerated linear algebra processing for Spark MLlib.</p>

<p>Spark MLlib defines Vector and Matrix as basic data types for machine learning algorithms. On top of them, <a href="https://en.wikipedia.org/wiki/Basic_Linear_Algebra_Subprograms">BLAS</a> and <a href="https://en.wikipedia.org/wiki/LAPACK">LAPACK</a> operations are implemented and supported by <a href="https://github.com/fommil/netlib-Java">netlib-java</a> (the algorithms may call <a href="https://github.com/scalanlp/breeze">Breeze</a> and it will in turn call <code class="highlighter-rouge">netlib-java</code>). <code class="highlighter-rouge">netlib-java</code> can use optimized native linear algebra libraries (refered to as &#8220;native libraries&#8221; or &#8220;BLAS libraries&#8221; hereafter) for faster numerical processing. <a href="https://software.intel.com/content/www/us/en/develop/tools/math-kernel-library.html">Intel MKL</a> and <a href="http://www.openblas.net">OpenBLAS</a> are two popular ones.</p>

<p>However due to license differences, the official released Spark binaries by default don&#8217;t contain native libraries support for <code class="highlighter-rouge">netlib-java</code>.</p>

<p>The following sections describe how to enable <code class="highlighter-rouge">netlib-java</code> with native libraries support for Spark MLlib and how to install native libraries and configure them properly.</p>

<h2 id="enable-netlib-java-with-native-library-proxies">Enable <code class="highlighter-rouge">netlib-java</code> with native library proxies</h2>

<p><code class="highlighter-rouge">netlib-java</code> depends on <code class="highlighter-rouge">libgfortran</code>. It requires GFORTRAN 1.4 or above. This can be obtained by installing <code class="highlighter-rouge">libgfortran</code> package. After installation, the following command can be used to verify if it is installed properly.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>strings /path/to/libgfortran.so.3.0.0 | grep GFORTRAN_1.4
</code></pre></div></div>

<p>To build Spark with <code class="highlighter-rouge">netlib-java</code> native library proxies, you need to add <code class="highlighter-rouge">-Pnetlib-lgpl</code> to Maven build command line. For example:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$SPARK_SOURCE_HOME/build/mvn -Pnetlib-lgpl -DskipTests -Pyarn -Phadoop-2.7 clean package
</code></pre></div></div>

<p>If you only want to enable it in your project, include <code class="highlighter-rouge">com.github.fommil.netlib:all:1.1.2</code> as a dependency of your project.</p>

<h2 id="install-native-linear-algebra-libraries">Install native linear algebra libraries</h2>

<p>Intel MKL and OpenBLAS are two popular native linear algebra libraries. You can choose one of them based on your preference. We provide basic instructions as below. You can refer to <a href="https://github.com/fommil/netlib-java">netlib-java documentation</a> for more advanced installation instructions.</p>

<h3 id="intel-mkl">Intel MKL</h3>

<ul>
  <li>Download and install Intel MKL. The installation should be done on all nodes of the cluster. We assume the installation location is $MKLROOT (e.g. /opt/intel/mkl).</li>
  <li>Create soft links to <code class="highlighter-rouge">libmkl_rt.so</code> with specific names in system library search paths. For instance, make sure <code class="highlighter-rouge">/usr/local/lib</code> is in system library search paths and run the following commands:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ln -sf $MKLROOT/lib/intel64/libmkl_rt.so /usr/local/lib/libblas.so.3
$ ln -sf $MKLROOT/lib/intel64/libmkl_rt.so /usr/local/lib/liblapack.so.3
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="openblas">OpenBLAS</h3>

<p>The installation should be done on all nodes of the cluster. Generic version of OpenBLAS are available with most distributions. You can install it with a distribution package manager like <code class="highlighter-rouge">apt</code> or <code class="highlighter-rouge">yum</code>.</p>

<p>For Debian / Ubuntu:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install libopenblas-base
sudo update-alternatives --config libblas.so.3
</code></pre></div></div>
<p>For CentOS / RHEL:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo yum install openblas
</code></pre></div></div>

<h2 id="check-if-native-libraries-are-enabled-for-mllib">Check if native libraries are enabled for MLlib</h2>

<p>To verify native libraries are properly loaded, start <code class="highlighter-rouge">spark-shell</code> and run the following code:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scala&gt; import com.github.fommil.netlib.BLAS;
scala&gt; System.out.println(BLAS.getInstance().getClass().getName());
</code></pre></div></div>

<p>If they are correctly loaded, it should print <code class="highlighter-rouge">com.github.fommil.netlib.NativeSystemBLAS</code>. Otherwise the warnings should be printed:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WARN BLAS: Failed to load implementation from:com.github.fommil.netlib.NativeSystemBLAS
WARN BLAS: Failed to load implementation from:com.github.fommil.netlib.NativeRefBLAS
</code></pre></div></div>

<p>If native libraries are not properly configured in the system, the Java implementation (f2jBLAS) will be used as fallback option.</p>

<h2 id="spark-configuration">Spark Configuration</h2>

<p>The default behavior of multi-threading in either Intel MKL or OpenBLAS may not be optimal with Spark&#8217;s execution model <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>.</p>

<p>Therefore configuring these native libraries to use a single thread for operations may actually improve performance (see <a href="https://issues.apache.org/jira/browse/SPARK-21305">SPARK-21305</a>). It is usually optimal to match this to the number of <code class="highlighter-rouge">spark.task.cpus</code>, which is <code class="highlighter-rouge">1</code> by default and typically left at <code class="highlighter-rouge">1</code>.</p>

<p>You can use the options in <code class="highlighter-rouge">config/spark-env.sh</code> to set thread number for Intel MKL or OpenBLAS:</p>
<ul>
  <li>For Intel MKL:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MKL_NUM_THREADS=1
</code></pre></div>    </div>
  </li>
  <li>For OpenBLAS:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>OPENBLAS_NUM_THREADS=1
</code></pre></div>    </div>
  </li>
</ul>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>Please refer to the following resources to understand how to configure the number of threads for these BLAS implementations: <a href="https://software.intel.com/en-us/articles/recommended-settings-for-calling-intel-mkl-routines-from-multi-threaded-applications">Intel MKL</a> or <a href="https://software.intel.com/en-us/onemkl-linux-developer-guide-improving-performance-with-threading">Intel oneMKL</a> and <a href="https://github.com/xianyi/OpenBLAS/wiki/faq#multi-threaded">OpenBLAS</a>.&#160;<a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>


                </div>
            
             <!-- /container -->
        </div>

        <script src="js/vendor/jquery-3.4.1.min.js"></script>
        <script src="js/vendor/bootstrap.min.js"></script>
        <script src="js/vendor/anchor.min.js"></script>
        <script src="js/main.js"></script>

        <!-- MathJax Section -->
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                TeX: { equationNumbers: { autoNumber: "AMS" } }
            });
        </script>
        <script>
            // Note that we load MathJax this way to work with local file (file://), HTTP and HTTPS.
            // We could use "//cdn.mathjax...", but that won't support "file://".
            (function(d, script) {
                script = d.createElement('script');
                script.type = 'text/javascript';
                script.async = true;
                script.onload = function(){
                    MathJax.Hub.Config({
                        tex2jax: {
                            inlineMath: [ ["$", "$"], ["\\\\(","\\\\)"] ],
                            displayMath: [ ["$$","$$"], ["\\[", "\\]"] ],
                            processEscapes: true,
                            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
                        }
                    });
                };
                script.src = ('https:' == document.location.protocol ? 'https://' : 'http://') +
                    'cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js' +
                    '?config=TeX-AMS-MML_HTMLorMML';
                d.getElementsByTagName('head')[0].appendChild(script);
            }(document));
        </script>
    </body>
</html>
