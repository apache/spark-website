
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>pyspark.sql.GroupedData.applyInPandasWithState &#8212; PySpark 3.4.2 documentation</title>
    
  <link rel="stylesheet" href="../../../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/pyspark.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="canonical" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.GroupedData.applyInPandasWithState.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="pyspark.sql.GroupedData.avg" href="pyspark.sql.GroupedData.avg.html" />
    <link rel="prev" title="pyspark.sql.GroupedData.applyInPandas" href="pyspark.sql.GroupedData.applyInPandas.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    <a class="navbar-brand" href="../../../index.html">
    
      <img src="../../../_static/spark-logo-reverse.png" class="logo" alt="logo" />
    
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../index.html">Overview</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../getting_started/index.html">Getting Started</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../user_guide/index.html">User Guides</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="../../index.html">API Reference</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../development/index.html">Development</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../migration_guide/index.html">Migration Guides</a>
        </li>
        
        
      </ul>


      

      <ul class="navbar-nav">
        
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

    <div class="bd-toc-item active">
    
  
    <ul class="nav bd-sidenav">
        
        
        
        
        
        
        
        
          
            
  
                <li class="active">
                    <a href="../index.html">Spark SQL</a>
                    <ul>
                    
                        <li class="">
                            <a href="../core_classes.html">Core Classes</a>
                        </li>
                    
                        <li class="">
                            <a href="../spark_session.html">Spark Session</a>
                        </li>
                    
                        <li class="">
                            <a href="../configuration.html">Configuration</a>
                        </li>
                    
                        <li class="">
                            <a href="../io.html">Input/Output</a>
                        </li>
                    
                        <li class="">
                            <a href="../dataframe.html">DataFrame</a>
                        </li>
                    
                        <li class="">
                            <a href="../column.html">Column</a>
                        </li>
                    
                        <li class="">
                            <a href="../data_types.html">Data Types</a>
                        </li>
                    
                        <li class="">
                            <a href="../row.html">Row</a>
                        </li>
                    
                        <li class="">
                            <a href="../functions.html">Functions</a>
                        </li>
                    
                        <li class="">
                            <a href="../window.html">Window</a>
                        </li>
                    
                        <li class="active">
                            <a href="../grouping.html">Grouping</a>
                        </li>
                    
                        <li class="">
                            <a href="../catalog.html">Catalog</a>
                        </li>
                    
                        <li class="">
                            <a href="../avro.html">Avro</a>
                        </li>
                    
                        <li class="">
                            <a href="../observation.html">Observation</a>
                        </li>
                    
                        <li class="">
                            <a href="../udf.html">UDF</a>
                        </li>
                    
                        <li class="">
                            <a href="../protobuf.html">Protobuf</a>
                        </li>
                    
                    </ul>
                </li>
            
          
            
                <li class="">
                    <a href="../../pyspark.pandas/index.html">Pandas API on Spark</a>
                </li>
            
          
            
                <li class="">
                    <a href="../../pyspark.ss/index.html">Structured Streaming</a>
                </li>
            
          
            
                <li class="">
                    <a href="../../pyspark.ml.html">MLlib (DataFrame-based)</a>
                </li>
            
          
            
                <li class="">
                    <a href="../../pyspark.streaming.html">Spark Streaming (Legacy)</a>
                </li>
            
          
            
                <li class="">
                    <a href="../../pyspark.mllib.html">MLlib (RDD-based)</a>
                </li>
            
          
            
                <li class="">
                    <a href="../../pyspark.html">Spark Core</a>
                </li>
            
          
            
                <li class="">
                    <a href="../../pyspark.resource.html">Resource Management</a>
                </li>
            
          
            
                <li class="">
                    <a href="../../pyspark.errors.html">Errors</a>
                </li>
            
          
        
        
        
        
        
        
      </ul>
  
  </nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
    </ul>
</nav>


              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="pyspark-sql-groupeddata-applyinpandaswithstate">
<h1>pyspark.sql.GroupedData.applyInPandasWithState<a class="headerlink" href="#pyspark-sql-groupeddata-applyinpandaswithstate" title="Permalink to this headline">¶</a></h1>
<dl class="py method">
<dt id="pyspark.sql.GroupedData.applyInPandasWithState">
<code class="sig-prename descclassname">GroupedData.</code><code class="sig-name descname">applyInPandasWithState</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">func</span><span class="p">:</span> <span class="n">PandasGroupedMapFunctionWithState</span></em>, <em class="sig-param"><span class="n">outputStructType</span><span class="p">:</span> <span class="n">Union<span class="p">[</span><a class="reference internal" href="pyspark.sql.types.StructType.html#pyspark.sql.types.StructType" title="pyspark.sql.types.StructType">pyspark.sql.types.StructType</a><span class="p">, </span>str<span class="p">]</span></span></em>, <em class="sig-param"><span class="n">stateStructType</span><span class="p">:</span> <span class="n">Union<span class="p">[</span><a class="reference internal" href="pyspark.sql.types.StructType.html#pyspark.sql.types.StructType" title="pyspark.sql.types.StructType">pyspark.sql.types.StructType</a><span class="p">, </span>str<span class="p">]</span></span></em>, <em class="sig-param"><span class="n">outputMode</span><span class="p">:</span> <span class="n">str</span></em>, <em class="sig-param"><span class="n">timeoutConf</span><span class="p">:</span> <span class="n">str</span></em><span class="sig-paren">)</span> &#x2192; pyspark.sql.dataframe.DataFrame<a class="headerlink" href="#pyspark.sql.GroupedData.applyInPandasWithState" title="Permalink to this definition">¶</a></dt>
<dd><p>Applies the given function to each group of data, while maintaining a user-defined
per-group state. The result Dataset will represent the flattened record returned by the
function.</p>
<p>For a streaming <a class="reference internal" href="pyspark.sql.DataFrame.html#pyspark.sql.DataFrame" title="pyspark.sql.DataFrame"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataFrame</span></code></a>, the function will be invoked first for all input groups
and then for all timed out states where the input data is set to be empty. Updates to each
group’s state will be saved across invocations.</p>
<p>The function should take parameters (key, Iterator[<cite>pandas.DataFrame</cite>], state) and
return another Iterator[<cite>pandas.DataFrame</cite>]. The grouping key(s) will be passed as a tuple
of numpy data types, e.g., <cite>numpy.int32</cite> and <cite>numpy.float64</cite>. The state will be passed as
<code class="xref py py-class docutils literal notranslate"><span class="pre">pyspark.sql.streaming.state.GroupState</span></code>.</p>
<p>For each group, all columns are passed together as <cite>pandas.DataFrame</cite> to the user-function,
and the returned <cite>pandas.DataFrame</cite> across all invocations are combined as a
<a class="reference internal" href="pyspark.sql.DataFrame.html#pyspark.sql.DataFrame" title="pyspark.sql.DataFrame"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataFrame</span></code></a>. Note that the user function should not make a guess of the number of
elements in the iterator. To process all data, the user function needs to iterate all
elements and process them. On the other hand, the user function is not strictly required to
iterate through all elements in the iterator if it intends to read a part of data.</p>
<p>The <cite>outputStructType</cite> should be a <code class="xref py py-class docutils literal notranslate"><span class="pre">StructType</span></code> describing the schema of all
elements in the returned value, <cite>pandas.DataFrame</cite>. The column labels of all elements in
returned <cite>pandas.DataFrame</cite> must either match the field names in the defined schema if
specified as strings, or match the field data types by position if not strings,
e.g. integer indices.</p>
<p>The <cite>stateStructType</cite> should be <code class="xref py py-class docutils literal notranslate"><span class="pre">StructType</span></code> describing the schema of the
user-defined state. The value of the state will be presented as a tuple, as well as the
update should be performed with the tuple. The corresponding Python types for
:class:DataType are supported. Please refer to the page
https://spark.apache.org/docs/latest/sql-ref-datatypes.html (Python tab).</p>
<p>The size of each <cite>pandas.DataFrame</cite> in both the input and output can be arbitrary. The
number of <cite>pandas.DataFrame</cite> in both the input and output can also be arbitrary.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 3.4.0.</span></p>
</div>
<dl class="field-list">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl>
<dt><strong>func</strong><span class="classifier">function</span></dt><dd><p>a Python native function to be called on every group. It should take parameters
(key, Iterator[<cite>pandas.DataFrame</cite>], state) and return Iterator[<cite>pandas.DataFrame</cite>].
Note that the type of the key is tuple and the type of the state is
<code class="xref py py-class docutils literal notranslate"><span class="pre">pyspark.sql.streaming.state.GroupState</span></code>.</p>
</dd>
<dt><strong>outputStructType</strong><span class="classifier"><a class="reference internal" href="pyspark.sql.types.DataType.html#pyspark.sql.types.DataType" title="pyspark.sql.types.DataType"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyspark.sql.types.DataType</span></code></a> or str</span></dt><dd><p>the type of the output records. The value can be either a
<a class="reference internal" href="pyspark.sql.types.DataType.html#pyspark.sql.types.DataType" title="pyspark.sql.types.DataType"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyspark.sql.types.DataType</span></code></a> object or a DDL-formatted type string.</p>
</dd>
<dt><strong>stateStructType</strong><span class="classifier"><a class="reference internal" href="pyspark.sql.types.DataType.html#pyspark.sql.types.DataType" title="pyspark.sql.types.DataType"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyspark.sql.types.DataType</span></code></a> or str</span></dt><dd><p>the type of the user-defined state. The value can be either a
<a class="reference internal" href="pyspark.sql.types.DataType.html#pyspark.sql.types.DataType" title="pyspark.sql.types.DataType"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyspark.sql.types.DataType</span></code></a> object or a DDL-formatted type string.</p>
</dd>
<dt><strong>outputMode</strong><span class="classifier">str</span></dt><dd><p>the output mode of the function.</p>
</dd>
<dt><strong>timeoutConf</strong><span class="classifier">str</span></dt><dd><p>timeout configuration for groups that do not receive data for a while. valid values
are defined in <code class="xref py py-class docutils literal notranslate"><span class="pre">pyspark.sql.streaming.state.GroupStateTimeout</span></code>.</p>
</dd>
</dl>
</dd>
</dl>
<p class="rubric">Notes</p>
<p>This function requires a full shuffle.</p>
<p>This API is experimental.</p>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.sql.streaming.state</span> <span class="kn">import</span> <span class="n">GroupStateTimeout</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">count_fn</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">pdf_iter</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">GroupStateImpl</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">total_len</span> <span class="o">=</span> <span class="mi">0</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">pdf</span> <span class="ow">in</span> <span class="n">pdf_iter</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">total_len</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">state</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">total_len</span><span class="p">,))</span>
<span class="gp">... </span>    <span class="k">yield</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s2">&quot;countAsString&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">total_len</span><span class="p">)]})</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">applyInPandasWithState</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">count_fn</span><span class="p">,</span> <span class="n">outputStructType</span><span class="o">=</span><span class="s2">&quot;id long, countAsString string&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">stateStructType</span><span class="o">=</span><span class="s2">&quot;len long&quot;</span><span class="p">,</span> <span class="n">outputMode</span><span class="o">=</span><span class="s2">&quot;Update&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">timeoutConf</span><span class="o">=</span><span class="n">GroupStateTimeout</span><span class="o">.</span><span class="n">NoTimeout</span><span class="p">)</span> 
</pre></div>
</div>
</dd></dl>

</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="pyspark.sql.GroupedData.applyInPandas.html" title="previous page">pyspark.sql.GroupedData.applyInPandas</a>
    <a class='right-next' id="next-link" href="pyspark.sql.GroupedData.avg.html" title="next page">pyspark.sql.GroupedData.avg</a>

              </div>
              
          </main>
          

      </div>
    </div>

    
  <script src="../../../_static/js/index.3da636dd464baa7582d2.js"></script>


    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright .<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.4.<br/>
    </p>
  </div>
</footer>
  </body>
</html>