
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>pyspark.ml.functions.predict_batch_udf &#8212; PySpark 3.4.2 documentation</title>
    
  <link rel="stylesheet" href="../../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/pyspark.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="canonical" href="https://spark.apache.org/docs/latest/api/python/reference/api/pyspark.ml.functions.predict_batch_udf.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Vector" href="pyspark.ml.linalg.Vector.html" />
    <link rel="prev" title="pyspark.ml.functions.vector_to_array" href="pyspark.ml.functions.vector_to_array.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    <a class="navbar-brand" href="../../index.html">
    
      <img src="../../_static/spark-logo-reverse.png" class="logo" alt="logo" />
    
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../../index.html">Overview</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../getting_started/index.html">Getting Started</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../user_guide/index.html">User Guides</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="../index.html">API Reference</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../development/index.html">Development</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../migration_guide/index.html">Migration Guides</a>
        </li>
        
        
      </ul>


      

      <ul class="navbar-nav">
        
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

    <div class="bd-toc-item active">
    
  
    <ul class="nav bd-sidenav">
        
        
        
        
        
        
        
        
          
            
                <li class="">
                    <a href="../pyspark.sql/index.html">Spark SQL</a>
                </li>
            
          
            
                <li class="">
                    <a href="../pyspark.pandas/index.html">Pandas API on Spark</a>
                </li>
            
          
            
                <li class="">
                    <a href="../pyspark.ss/index.html">Structured Streaming</a>
                </li>
            
          
            
                <li class="active">
                    <a href="../pyspark.ml.html">MLlib (DataFrame-based)</a>
                </li>
            
          
            
                <li class="">
                    <a href="../pyspark.streaming.html">Spark Streaming (Legacy)</a>
                </li>
            
          
            
                <li class="">
                    <a href="../pyspark.mllib.html">MLlib (RDD-based)</a>
                </li>
            
          
            
                <li class="">
                    <a href="../pyspark.html">Spark Core</a>
                </li>
            
          
            
                <li class="">
                    <a href="../pyspark.resource.html">Resource Management</a>
                </li>
            
          
            
                <li class="">
                    <a href="../pyspark.errors.html">Errors</a>
                </li>
            
          
        
        
        
        
        
        
      </ul>
  
  </nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
    </ul>
</nav>


              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="pyspark-ml-functions-predict-batch-udf">
<h1>pyspark.ml.functions.predict_batch_udf<a class="headerlink" href="#pyspark-ml-functions-predict-batch-udf" title="Permalink to this headline">¶</a></h1>
<dl class="py function">
<dt id="pyspark.ml.functions.predict_batch_udf">
<code class="sig-prename descclassname">pyspark.ml.functions.</code><code class="sig-name descname">predict_batch_udf</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">make_predict_fn</span><span class="p">:</span> <span class="n">Callable<span class="p">[</span><span class="p">]</span><span class="p">, </span>PredictBatchFunction<span class="p">]</span></span></em>, <em class="sig-param"><span class="o">*</span></em>, <em class="sig-param"><span class="n">return_type</span><span class="p">:</span> <span class="n">DataType</span></em>, <em class="sig-param"><span class="n">batch_size</span><span class="p">:</span> <span class="n">int</span></em>, <em class="sig-param"><span class="n">input_tensor_shapes</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>Union<span class="p">[</span>List<span class="p">[</span>Optional<span class="p">[</span>List<span class="p">[</span>int<span class="p">]</span><span class="p">]</span><span class="p">]</span><span class="p">, </span>Mapping<span class="p">[</span>int<span class="p">, </span>List<span class="p">[</span>int<span class="p">]</span><span class="p">]</span><span class="p">]</span><span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em><span class="sig-paren">)</span> &#x2192; UserDefinedFunctionLike<a class="reference internal" href="../../_modules/pyspark/ml/functions.html#predict_batch_udf"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#pyspark.ml.functions.predict_batch_udf" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a function which loads a model and returns a <cite>predict</cite> function for inference over a
batch of numpy inputs, returns a Pandas UDF wrapper for inference over a Spark DataFrame.</p>
<p>The returned Pandas UDF does the following on each DataFrame partition:</p>
<ul class="simple">
<li><p>calls the <cite>make_predict_fn</cite> to load the model and cache its <cite>predict</cite> function.</p></li>
<li><p>batches the input records as numpy arrays and invokes <cite>predict</cite> on each batch.</p></li>
</ul>
<p>Note: this assumes that the <cite>make_predict_fn</cite> encapsulates all of the necessary dependencies for
running the model, or the Spark executor environment already satisfies all runtime requirements.</p>
<p>For the conversion of the Spark DataFrame to numpy arrays, there is a one-to-one mapping between
the input arguments of the <cite>predict</cite> function (returned by the <cite>make_predict_fn</cite>) and the input
columns sent to the Pandas UDF (returned by the <cite>predict_batch_udf</cite>) at runtime.  Each input
column will be converted as follows:</p>
<ul class="simple">
<li><p>scalar column -&gt; 1-dim np.ndarray</p></li>
<li><p>tensor column + tensor shape -&gt; N-dim np.ndarray</p></li>
</ul>
<p>Note that any tensor columns in the Spark DataFrame must be represented as a flattened
one-dimensional array, and multiple scalar columns can be combined into a single tensor column
using the standard <a class="reference internal" href="../pyspark.sql/api/pyspark.sql.functions.array.html#pyspark.sql.functions.array" title="pyspark.sql.functions.array"><code class="xref py py-func docutils literal notranslate"><span class="pre">pyspark.sql.functions.array()</span></code></a> function.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 3.4.0.</span></p>
</div>
<dl class="field-list">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl>
<dt><strong>make_predict_fn</strong><span class="classifier">callable</span></dt><dd><p>Function which is responsible for loading a model and returning a
<code class="xref py py-class docutils literal notranslate"><span class="pre">PredictBatchFunction</span></code> which takes one or more numpy arrays as input and returns
one of the following:</p>
<ul class="simple">
<li><p>a numpy array (for a single output)</p></li>
<li><p>a dictionary of named numpy arrays (for multiple outputs)</p></li>
<li><p>a row-oriented list of dictionaries (for multiple outputs).</p></li>
</ul>
<p>For a dictionary of named numpy arrays, the arrays can only be one or two dimensional, since
higher dimensional arrays are not supported.  For a row-oriented list of dictionaries, each
element in the dictionary must be either a scalar or one-dimensional array.</p>
</dd>
<dt><strong>return_type</strong><span class="classifier"><a class="reference internal" href="../pyspark.sql/api/pyspark.sql.types.DataType.html#pyspark.sql.types.DataType" title="pyspark.sql.types.DataType"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyspark.sql.types.DataType</span></code></a> or str.</span></dt><dd><p>Spark SQL datatype for the expected output:</p>
<ul class="simple">
<li><p>Scalar (e.g. IntegerType, FloatType) –&gt; 1-dim numpy array.</p></li>
<li><p>ArrayType –&gt; 2-dim numpy array.</p></li>
<li><p>StructType –&gt; dict with keys matching struct fields.</p></li>
<li><p>StructType –&gt; list of dict with keys matching struct fields, for models like the
<a class="reference external" href="https://huggingface.co/docs/transformers/quicktour#pipeline-usage">Huggingface pipeline for sentiment analysis</a>.</p></li>
</ul>
</dd>
<dt><strong>batch_size</strong><span class="classifier">int</span></dt><dd><p>Batch size to use for inference.  This is typically a limitation of the model
and/or available hardware resources and is usually smaller than the Spark partition size.</p>
</dd>
<dt><strong>input_tensor_shapes</strong><span class="classifier">list, dict, optional.</span></dt><dd><p>A list of ints or a dictionary of ints (key) and list of ints (value).
Input tensor shapes for models with tensor inputs.  This can be a list of shapes,
where each shape is a list of integers or None (for scalar inputs).  Alternatively, this
can be represented by a “sparse” dictionary, where the keys are the integer indices of the
inputs, and the values are the shapes.  Each tensor input value in the Spark DataFrame must
be represented as a single column containing a flattened 1-D array.  The provided
<cite>input_tensor_shapes</cite> will be used to reshape the flattened array into the expected tensor
shape.  For the list form, the order of the tensor shapes must match the order of the
selected DataFrame columns.  The batch dimension (typically -1 or None in the first
dimension) should not be included, since it will be determined by the batch_size argument.
Tabular datasets with scalar-valued columns should not provide this argument.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><code class="xref py py-class docutils literal notranslate"><span class="pre">UserDefinedFunctionLike</span></code></dt><dd><p>A Pandas UDF for model inference on a Spark DataFrame.</p>
</dd>
</dl>
</dd>
</dl>
<p class="rubric">Examples</p>
<p>For a pre-trained TensorFlow MNIST model with two-dimensional input images represented as a
flattened tensor value stored in a single Spark DataFrame column of type <cite>array&lt;float&gt;</cite>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.ml.functions</span> <span class="kn">import</span> <span class="n">predict_batch_udf</span>

<span class="k">def</span> <span class="nf">make_mnist_fn</span><span class="p">():</span>
    <span class="c1"># load/init happens once per python worker</span>
    <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s1">&#39;/path/to/mnist_model&#39;</span><span class="p">)</span>

    <span class="c1"># predict on batches of tasks/partitions, using cached model</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">inputs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="c1"># inputs.shape = [batch_size, 784], see input_tensor_shapes</span>
        <span class="c1"># outputs.shape = [batch_size, 10], see return_type</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">predict</span>

<span class="n">mnist_udf</span> <span class="o">=</span> <span class="n">predict_batch_udf</span><span class="p">(</span><span class="n">make_mnist_fn</span><span class="p">,</span>
                              <span class="n">return_type</span><span class="o">=</span><span class="n">ArrayType</span><span class="p">(</span><span class="n">FloatType</span><span class="p">()),</span>
                              <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                              <span class="n">input_tensor_shapes</span><span class="o">=</span><span class="p">[[</span><span class="mi">784</span><span class="p">]])</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="s2">&quot;/path/to/mnist_data&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="c1"># +--------------------+</span>
<span class="c1"># |                data|</span>
<span class="c1"># +--------------------+</span>
<span class="c1"># |[0.0, 0.0, 0.0, 0...|</span>
<span class="c1"># |[0.0, 0.0, 0.0, 0...|</span>
<span class="c1"># |[0.0, 0.0, 0.0, 0...|</span>
<span class="c1"># |[0.0, 0.0, 0.0, 0...|</span>
<span class="c1"># |[0.0, 0.0, 0.0, 0...|</span>
<span class="c1"># +--------------------+</span>

<span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;preds&quot;</span><span class="p">,</span> <span class="n">mnist_udf</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="c1"># +--------------------+--------------------+</span>
<span class="c1"># |                data|               preds|</span>
<span class="c1"># +--------------------+--------------------+</span>
<span class="c1"># |[0.0, 0.0, 0.0, 0...|[-13.511008, 8.84...|</span>
<span class="c1"># |[0.0, 0.0, 0.0, 0...|[-5.3957458, -2.2...|</span>
<span class="c1"># |[0.0, 0.0, 0.0, 0...|[-7.2014456, -8.8...|</span>
<span class="c1"># |[0.0, 0.0, 0.0, 0...|[-19.466187, -13....|</span>
<span class="c1"># |[0.0, 0.0, 0.0, 0...|[-5.7757926, -7.8...|</span>
<span class="c1"># +--------------------+--------------------+</span>
</pre></div>
</div>
<p>To demonstrate usage with different combinations of input and output types, the following
examples just use simple mathematical transforms as the models.</p>
<ul>
<li><dl>
<dt>Single scalar column</dt><dd><p>Input DataFrame has a single scalar column, which will be passed to the <cite>predict</cite>
function as a 1-D numpy array.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.ml.functions</span> <span class="kn">import</span> <span class="n">predict_batch_udf</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">FloatType</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">)))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="go">+---+</span>
<span class="go">|  0|</span>
<span class="go">+---+</span>
<span class="go">|  0|</span>
<span class="go">|  1|</span>
<span class="go">|  2|</span>
<span class="go">|  3|</span>
<span class="go">|  4|</span>
<span class="go">+---+</span>
<span class="go">only showing top 5 rows</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">make_times_two_fn</span><span class="p">():</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">inputs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="gp">... </span>        <span class="c1"># inputs.shape = [batch_size]</span>
<span class="gp">... </span>        <span class="c1"># outputs.shape = [batch_size]</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">inputs</span> <span class="o">*</span> <span class="mi">2</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">predict</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">times_two_udf</span> <span class="o">=</span> <span class="n">predict_batch_udf</span><span class="p">(</span><span class="n">make_times_two_fn</span><span class="p">,</span>
<span class="gp">... </span>                                  <span class="n">return_type</span><span class="o">=</span><span class="n">FloatType</span><span class="p">(),</span>
<span class="gp">... </span>                                  <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">)))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="n">times_two_udf</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="go">+---+---+</span>
<span class="go">|  0| x2|</span>
<span class="go">+---+---+</span>
<span class="go">|  0|0.0|</span>
<span class="go">|  1|2.0|</span>
<span class="go">|  2|4.0|</span>
<span class="go">|  3|6.0|</span>
<span class="go">|  4|8.0|</span>
<span class="go">+---+---+</span>
<span class="go">only showing top 5 rows</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>Multiple scalar columns</dt><dd><p>Input DataFrame has muliple columns of scalar values.  If the user-provided <cite>predict</cite>
function expects a single input, then the user must combine the multiple columns into a
single tensor using <cite>pyspark.sql.functions.array</cite>.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.ml.functions</span> <span class="kn">import</span> <span class="n">predict_batch_udf</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">array</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="go">+----+----+----+----+</span>
<span class="go">|   a|   b|   c|   d|</span>
<span class="go">+----+----+----+----+</span>
<span class="go">| 0.0| 1.0| 2.0| 3.0|</span>
<span class="go">| 4.0| 5.0| 6.0| 7.0|</span>
<span class="go">| 8.0| 9.0|10.0|11.0|</span>
<span class="go">|12.0|13.0|14.0|15.0|</span>
<span class="go">|16.0|17.0|18.0|19.0|</span>
<span class="go">+----+----+----+----+</span>
<span class="go">only showing top 5 rows</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">make_sum_fn</span><span class="p">():</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">inputs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="gp">... </span>        <span class="c1"># inputs.shape = [batch_size, 4]</span>
<span class="gp">... </span>        <span class="c1"># outputs.shape = [batch_size]</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">predict</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sum_udf</span> <span class="o">=</span> <span class="n">predict_batch_udf</span><span class="p">(</span><span class="n">make_sum_fn</span><span class="p">,</span>
<span class="gp">... </span>                            <span class="n">return_type</span><span class="o">=</span><span class="n">FloatType</span><span class="p">(),</span>
<span class="gp">... </span>                            <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="gp">... </span>                            <span class="n">input_tensor_shapes</span><span class="o">=</span><span class="p">[[</span><span class="mi">4</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">sum_udf</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">)))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="go">+----+----+----+----+----+</span>
<span class="go">|   a|   b|   c|   d| sum|</span>
<span class="go">+----+----+----+----+----+</span>
<span class="go">| 0.0| 1.0| 2.0| 3.0| 6.0|</span>
<span class="go">| 4.0| 5.0| 6.0| 7.0|22.0|</span>
<span class="go">| 8.0| 9.0|10.0|11.0|38.0|</span>
<span class="go">|12.0|13.0|14.0|15.0|54.0|</span>
<span class="go">|16.0|17.0|18.0|19.0|70.0|</span>
<span class="go">+----+----+----+----+----+</span>
<span class="go">only showing top 5 rows</span>
</pre></div>
</div>
<p>If the <cite>predict</cite> function expects multiple inputs, then the number of selected input columns
must match the number of expected inputs.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">make_sum_fn</span><span class="p">():</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">x1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">x2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">x3</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">x4</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="gp">... </span>        <span class="c1"># xN.shape = [batch_size]</span>
<span class="gp">... </span>        <span class="c1"># outputs.shape = [batch_size]</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">x3</span> <span class="o">+</span> <span class="n">x4</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">predict</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sum_udf</span> <span class="o">=</span> <span class="n">predict_batch_udf</span><span class="p">(</span><span class="n">make_sum_fn</span><span class="p">,</span>
<span class="gp">... </span>                            <span class="n">return_type</span><span class="o">=</span><span class="n">FloatType</span><span class="p">(),</span>
<span class="gp">... </span>                            <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">sum_udf</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="go">+----+----+----+----+----+</span>
<span class="go">|   a|   b|   c|   d| sum|</span>
<span class="go">+----+----+----+----+----+</span>
<span class="go">| 0.0| 1.0| 2.0| 3.0| 6.0|</span>
<span class="go">| 4.0| 5.0| 6.0| 7.0|22.0|</span>
<span class="go">| 8.0| 9.0|10.0|11.0|38.0|</span>
<span class="go">|12.0|13.0|14.0|15.0|54.0|</span>
<span class="go">|16.0|17.0|18.0|19.0|70.0|</span>
<span class="go">+----+----+----+----+----+</span>
<span class="go">only showing top 5 rows</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>Multiple tensor columns</dt><dd><p>Input DataFrame has multiple columns, where each column is a tensor.  The number of columns
should match the number of expected inputs for the user-provided <cite>predict</cite> function.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.ml.functions</span> <span class="kn">import</span> <span class="n">predict_batch_udf</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">,</span> <span class="n">StructType</span><span class="p">,</span> <span class="n">StructField</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Mapping</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pdf_tensor</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pdf_tensor</span><span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pdf_tensor</span><span class="p">[</span><span class="s1">&#39;t2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">pdf_tensor</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="go">+--------------------+------------------+</span>
<span class="go">|                  t1|                t2|</span>
<span class="go">+--------------------+------------------+</span>
<span class="go">|[0.0, 1.0, 2.0, 3.0]|   [0.0, 1.0, 2.0]|</span>
<span class="go">|[4.0, 5.0, 6.0, 7.0]|   [4.0, 5.0, 6.0]|</span>
<span class="go">|[8.0, 9.0, 10.0, ...|  [8.0, 9.0, 10.0]|</span>
<span class="go">|[12.0, 13.0, 14.0...|[12.0, 13.0, 14.0]|</span>
<span class="go">|[16.0, 17.0, 18.0...|[16.0, 17.0, 18.0]|</span>
<span class="go">+--------------------+------------------+</span>
<span class="go">only showing top 5 rows</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">make_multi_sum_fn</span><span class="p">():</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">x1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="gp">... </span>        <span class="c1"># x1.shape = [batch_size, 4]</span>
<span class="gp">... </span>        <span class="c1"># x2.shape = [batch_size, 3]</span>
<span class="gp">... </span>        <span class="c1"># outputs.shape = [batch_size]</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">predict</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">multi_sum_udf</span> <span class="o">=</span> <span class="n">predict_batch_udf</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">make_multi_sum_fn</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">return_type</span><span class="o">=</span><span class="n">FloatType</span><span class="p">(),</span>
<span class="gp">... </span>    <span class="n">batch_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">input_tensor_shapes</span><span class="o">=</span><span class="p">[[</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">multi_sum_udf</span><span class="p">(</span><span class="s2">&quot;t1&quot;</span><span class="p">,</span> <span class="s2">&quot;t2&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="go">+--------------------+------------------+-----+</span>
<span class="go">|                  t1|                t2|  sum|</span>
<span class="go">+--------------------+------------------+-----+</span>
<span class="go">|[0.0, 1.0, 2.0, 3.0]|   [0.0, 1.0, 2.0]|  9.0|</span>
<span class="go">|[4.0, 5.0, 6.0, 7.0]|   [4.0, 5.0, 6.0]| 37.0|</span>
<span class="go">|[8.0, 9.0, 10.0, ...|  [8.0, 9.0, 10.0]| 65.0|</span>
<span class="go">|[12.0, 13.0, 14.0...|[12.0, 13.0, 14.0]| 93.0|</span>
<span class="go">|[16.0, 17.0, 18.0...|[16.0, 17.0, 18.0]|121.0|</span>
<span class="go">+--------------------+------------------+-----+</span>
<span class="go">only showing top 5 rows</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>Multiple outputs</dt><dd><p>Some models can provide multiple outputs.  These can be returned as a dictionary of named
values, which can be represented in either columnar or row-based formats.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">make_multi_sum_fn</span><span class="p">():</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">predict_columnar</span><span class="p">(</span><span class="n">x1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="gp">... </span>        <span class="c1"># x1.shape = [batch_size, 4]</span>
<span class="gp">... </span>        <span class="c1"># x2.shape = [batch_size, 3]</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="p">{</span>
<span class="gp">... </span>            <span class="s2">&quot;sum1&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="gp">... </span>            <span class="s2">&quot;sum2&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">... </span>        <span class="p">}</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">predict_columnar</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">multi_sum_udf</span> <span class="o">=</span> <span class="n">predict_batch_udf</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">make_multi_sum_fn</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">return_type</span><span class="o">=</span><span class="n">StructType</span><span class="p">([</span>
<span class="gp">... </span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;sum1&quot;</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
<span class="gp">... </span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;sum2&quot;</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span>
<span class="gp">... </span>    <span class="p">]),</span>
<span class="gp">... </span>    <span class="n">batch_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">input_tensor_shapes</span><span class="o">=</span><span class="p">[[</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;preds&quot;</span><span class="p">,</span> <span class="n">multi_sum_udf</span><span class="p">(</span><span class="s2">&quot;t1&quot;</span><span class="p">,</span> <span class="s2">&quot;t2&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;t1&quot;</span><span class="p">,</span> <span class="s2">&quot;t2&quot;</span><span class="p">,</span> <span class="s2">&quot;preds.*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="go">+--------------------+------------------+----+----+</span>
<span class="go">|                  t1|                t2|sum1|sum2|</span>
<span class="go">+--------------------+------------------+----+----+</span>
<span class="go">|[0.0, 1.0, 2.0, 3.0]|   [0.0, 1.0, 2.0]| 6.0| 3.0|</span>
<span class="go">|[4.0, 5.0, 6.0, 7.0]|   [4.0, 5.0, 6.0]|22.0|15.0|</span>
<span class="go">|[8.0, 9.0, 10.0, ...|  [8.0, 9.0, 10.0]|38.0|27.0|</span>
<span class="go">|[12.0, 13.0, 14.0...|[12.0, 13.0, 14.0]|54.0|39.0|</span>
<span class="go">|[16.0, 17.0, 18.0...|[16.0, 17.0, 18.0]|70.0|51.0|</span>
<span class="go">+--------------------+------------------+----+----+</span>
<span class="go">only showing top 5 rows</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">make_multi_sum_fn</span><span class="p">():</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">predict_row</span><span class="p">(</span><span class="n">x1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="gp">... </span>        <span class="c1"># x1.shape = [batch_size, 4]</span>
<span class="gp">... </span>        <span class="c1"># x2.shape = [batch_size, 3]</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="p">[{</span><span class="s1">&#39;sum1&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="s1">&#39;sum2&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x2</span><span class="p">[</span><span class="n">i</span><span class="p">])}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x1</span><span class="p">))]</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">predict_row</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">multi_sum_udf</span> <span class="o">=</span> <span class="n">predict_batch_udf</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">make_multi_sum_fn</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">return_type</span><span class="o">=</span><span class="n">StructType</span><span class="p">([</span>
<span class="gp">... </span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;sum1&quot;</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
<span class="gp">... </span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;sum2&quot;</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span>
<span class="gp">... </span>    <span class="p">]),</span>
<span class="gp">... </span>    <span class="n">batch_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">input_tensor_shapes</span><span class="o">=</span><span class="p">[[</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">multi_sum_udf</span><span class="p">(</span><span class="s2">&quot;t1&quot;</span><span class="p">,</span> <span class="s2">&quot;t2&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;t1&quot;</span><span class="p">,</span> <span class="s2">&quot;t2&quot;</span><span class="p">,</span> <span class="s2">&quot;sum.*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="go">+--------------------+------------------+----+----+</span>
<span class="go">|                  t1|                t2|sum1|sum2|</span>
<span class="go">+--------------------+------------------+----+----+</span>
<span class="go">|[0.0, 1.0, 2.0, 3.0]|   [0.0, 1.0, 2.0]| 6.0| 3.0|</span>
<span class="go">|[4.0, 5.0, 6.0, 7.0]|   [4.0, 5.0, 6.0]|22.0|15.0|</span>
<span class="go">|[8.0, 9.0, 10.0, ...|  [8.0, 9.0, 10.0]|38.0|27.0|</span>
<span class="go">|[12.0, 13.0, 14.0...|[12.0, 13.0, 14.0]|54.0|39.0|</span>
<span class="go">|[16.0, 17.0, 18.0...|[16.0, 17.0, 18.0]|70.0|51.0|</span>
<span class="go">+--------------------+------------------+----+----+</span>
<span class="go">only showing top 5 rows</span>
</pre></div>
</div>
<p>Note that the multiple outputs can be arrays as well.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">make_multi_times_two_fn</span><span class="p">():</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">x1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="gp">... </span>        <span class="c1"># x1.shape = [batch_size, 4]</span>
<span class="gp">... </span>        <span class="c1"># x2.shape = [batch_size, 3]</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;t1x2&quot;</span><span class="p">:</span> <span class="n">x1</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;t2x2&quot;</span><span class="p">:</span> <span class="n">x2</span> <span class="o">*</span> <span class="mi">2</span><span class="p">}</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">predict</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">multi_times_two_udf</span> <span class="o">=</span> <span class="n">predict_batch_udf</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">make_multi_times_two_fn</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">return_type</span><span class="o">=</span><span class="n">StructType</span><span class="p">([</span>
<span class="gp">... </span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;t1x2&quot;</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">(</span><span class="n">FloatType</span><span class="p">()),</span> <span class="kc">True</span><span class="p">),</span>
<span class="gp">... </span>        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;t2x2&quot;</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">(</span><span class="n">FloatType</span><span class="p">()),</span> <span class="kc">True</span><span class="p">)</span>
<span class="gp">... </span>    <span class="p">]),</span>
<span class="gp">... </span>    <span class="n">batch_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">input_tensor_shapes</span><span class="o">=</span><span class="p">[[</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="n">multi_times_two_udf</span><span class="p">(</span><span class="s2">&quot;t1&quot;</span><span class="p">,</span> <span class="s2">&quot;t2&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;t1&quot;</span><span class="p">,</span> <span class="s2">&quot;t2&quot;</span><span class="p">,</span> <span class="s2">&quot;x2.*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="go">+--------------------+------------------+--------------------+------------------+</span>
<span class="go">|                  t1|                t2|                t1x2|              t2x2|</span>
<span class="go">+--------------------+------------------+--------------------+------------------+</span>
<span class="go">|[0.0, 1.0, 2.0, 3.0]|   [0.0, 1.0, 2.0]|[0.0, 2.0, 4.0, 6.0]|   [0.0, 2.0, 4.0]|</span>
<span class="go">|[4.0, 5.0, 6.0, 7.0]|   [4.0, 5.0, 6.0]|[8.0, 10.0, 12.0,...| [8.0, 10.0, 12.0]|</span>
<span class="go">|[8.0, 9.0, 10.0, ...|  [8.0, 9.0, 10.0]|[16.0, 18.0, 20.0...|[16.0, 18.0, 20.0]|</span>
<span class="go">|[12.0, 13.0, 14.0...|[12.0, 13.0, 14.0]|[24.0, 26.0, 28.0...|[24.0, 26.0, 28.0]|</span>
<span class="go">|[16.0, 17.0, 18.0...|[16.0, 17.0, 18.0]|[32.0, 34.0, 36.0...|[32.0, 34.0, 36.0]|</span>
<span class="go">+--------------------+------------------+--------------------+------------------+</span>
<span class="go">only showing top 5 rows</span>
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
</dd></dl>

</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="pyspark.ml.functions.vector_to_array.html" title="previous page">pyspark.ml.functions.vector_to_array</a>
    <a class='right-next' id="next-link" href="pyspark.ml.linalg.Vector.html" title="next page">Vector</a>

              </div>
              
          </main>
          

      </div>
    </div>

    
  <script src="../../_static/js/index.3da636dd464baa7582d2.js"></script>


    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright .<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.4.<br/>
    </p>
  </div>
</footer>
  </body>
</html>