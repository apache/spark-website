
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>pyspark.pandas.mlflow.load_model &#8212; PySpark 3.3.1 documentation</title>
    
  <link rel="stylesheet" href="../../../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/pyspark.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="canonical" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.pandas/api/pyspark.pandas.mlflow.load_model.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Extensions" href="../extensions.html" />
    <link rel="prev" title="pyspark.pandas.mlflow.PythonModelWrapper" href="pyspark.pandas.mlflow.PythonModelWrapper.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    <a class="navbar-brand" href="../../../index.html">
    
      <img src="../../../_static/spark-logo-reverse.png" class="logo" alt="logo" />
    
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../getting_started/index.html">Getting Started</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../user_guide/index.html">User Guide</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="../../index.html">API Reference</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../development/index.html">Development</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../migration_guide/index.html">Migration Guide</a>
        </li>
        
        
      </ul>


      

      <ul class="navbar-nav">
        
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

    <div class="bd-toc-item active">
    
  
    <ul class="nav bd-sidenav">
        
        
        
        
        
        
          
            
                <li class="">
                    <a href="../../pyspark.sql/index.html">Spark SQL</a>
                </li>
            
          
            
  
                <li class="active">
                    <a href="../index.html">Pandas API on Spark</a>
                    <ul>
                    
                        <li class="">
                            <a href="../io.html">Input/Output</a>
                        </li>
                    
                        <li class="">
                            <a href="../general_functions.html">General functions</a>
                        </li>
                    
                        <li class="">
                            <a href="../series.html">Series</a>
                        </li>
                    
                        <li class="">
                            <a href="../frame.html">DataFrame</a>
                        </li>
                    
                        <li class="">
                            <a href="../indexing.html">Index objects</a>
                        </li>
                    
                        <li class="">
                            <a href="../window.html">Window</a>
                        </li>
                    
                        <li class="">
                            <a href="../groupby.html">GroupBy</a>
                        </li>
                    
                        <li class="active">
                            <a href="../ml.html">Machine Learning utilities</a>
                        </li>
                    
                        <li class="">
                            <a href="../extensions.html">Extensions</a>
                        </li>
                    
                    </ul>
                </li>
            
          
            
                <li class="">
                    <a href="../../pyspark.ss/index.html">Structured Streaming</a>
                </li>
            
          
            
                <li class="">
                    <a href="../../pyspark.ml.html">MLlib (DataFrame-based)</a>
                </li>
            
          
            
                <li class="">
                    <a href="../../pyspark.streaming.html">Spark Streaming</a>
                </li>
            
          
            
                <li class="">
                    <a href="../../pyspark.mllib.html">MLlib (RDD-based)</a>
                </li>
            
          
            
                <li class="">
                    <a href="../../pyspark.html">Spark Core</a>
                </li>
            
          
            
                <li class="">
                    <a href="../../pyspark.resource.html">Resource Management</a>
                </li>
            
          
        
        
        
        
        
        
      </ul>
  
  </nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
    </ul>
</nav>


              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="pyspark-pandas-mlflow-load-model">
<h1>pyspark.pandas.mlflow.load_model<a class="headerlink" href="#pyspark-pandas-mlflow-load-model" title="Permalink to this headline">¶</a></h1>
<dl class="py function">
<dt id="pyspark.pandas.mlflow.load_model">
<code class="sig-prename descclassname">pyspark.pandas.mlflow.</code><code class="sig-name descname">load_model</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">model_uri</span><span class="p">:</span> <span class="n">str</span></em>, <em class="sig-param"><span class="n">predict_type</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>str<span class="p">, </span>type<span class="p">, </span>numpy.dtype<span class="p">, </span>pandas.core.dtypes.base.ExtensionDtype<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">'infer'</span></em><span class="sig-paren">)</span> &#x2192; <a class="reference internal" href="pyspark.pandas.mlflow.PythonModelWrapper.html#pyspark.pandas.mlflow.PythonModelWrapper" title="pyspark.pandas.mlflow.PythonModelWrapper">pyspark.pandas.mlflow.PythonModelWrapper</a><a class="reference internal" href="../../../_modules/pyspark/pandas/mlflow.html#load_model"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#pyspark.pandas.mlflow.load_model" title="Permalink to this definition">¶</a></dt>
<dd><p>Loads an MLflow model into an wrapper that can be used both for pandas and pandas-on-Spark
DataFrame.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>model_uri</strong><span class="classifier">str</span></dt><dd><p>URI pointing to the model. See MLflow documentation for more details.</p>
</dd>
<dt><strong>predict_type</strong><span class="classifier">a python basic type, a numpy basic type, a Spark type or ‘infer’.</span></dt><dd><p>This is the return type that is expected when calling the predict function of the model.
If ‘infer’ is specified, the wrapper will attempt to determine automatically the return type
based on the model type.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>PythonModelWrapper</dt><dd><p>A wrapper around MLflow PythonModel objects. This wrapper is expected to adhere to the
interface of mlflow.pyfunc.PythonModel.</p>
</dd>
</dl>
</dd>
</dl>
<p class="rubric">Notes</p>
<p>Currently, the model prediction can only be merged back with the existing dataframe.
Other columns have to be manually joined.
For example, this code will not work:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.0</span><span class="p">],</span> <span class="s2">&quot;x2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">],</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;x2&quot;</span><span class="p">]]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Works:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>   
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Will fail with a message about dataframes not aligned.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>   
</pre></div>
</div>
<p>A current workaround is to use the .merge() function, using the feature values
as merging keys.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">everything</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span> <span class="s1">&#39;x2&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">everything</span>
<span class="go">    x1   x2  z         y</span>
<span class="go">0  2.0  3.0 -1  1.376932</span>
</pre></div>
</div>
<p class="rubric">Examples</p>
<dl class="simple">
<dt>Here is a full example that creates a model with scikit-learn and saves the model with</dt><dd><p>MLflow. The model is then loaded as a predictor that can be applied on a pandas-on-Spark
Dataframe.</p>
</dd>
</dl>
<p>We first initialize our MLflow environment:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">mlflow.tracking</span> <span class="kn">import</span> <span class="n">MlflowClient</span><span class="p">,</span> <span class="n">set_tracking_uri</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">mlflow.sklearn</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">mkdtemp</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span> <span class="o">=</span> <span class="n">mkdtemp</span><span class="p">(</span><span class="s2">&quot;pandas_on_spark_mlflow&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="s2">&quot;file:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">d</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">client</span> <span class="o">=</span> <span class="n">MlflowClient</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp_id</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">create_experiment</span><span class="p">(</span><span class="s2">&quot;my_experiment&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;my_experiment&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We aim at learning this numerical function using a simple linear regressor.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="s2">&quot;x2&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
<span class="gp">... </span>                      <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">8</span><span class="p">))})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">train_x</span> <span class="o">=</span> <span class="n">train</span><span class="p">[[</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;x2&quot;</span><span class="p">]]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">train_y</span> <span class="o">=</span> <span class="n">train</span><span class="p">[[</span><span class="s2">&quot;y&quot;</span><span class="p">]]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
<span class="gp">... </span>    <span class="n">lr</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span>
<span class="go">LinearRegression(...)</span>
</pre></div>
</div>
<p>Now that our model is logged using MLflow, we load it back and apply it on a pandas-on-Spark
dataframe:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.pandas.mlflow</span> <span class="kn">import</span> <span class="n">load_model</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">run_info</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">list_run_infos</span><span class="p">(</span><span class="n">exp_id</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;runs:/</span><span class="si">{run_id}</span><span class="s2">/model&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="n">run_info</span><span class="o">.</span><span class="n">run_uuid</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">prediction_df</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.0</span><span class="p">],</span> <span class="s2">&quot;x2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.0</span><span class="p">]})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">prediction_df</span><span class="p">[</span><span class="s2">&quot;prediction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">prediction_df</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">prediction_df</span>
<span class="go">    x1   x2  prediction</span>
<span class="go">0  2.0  4.0    1.355551</span>
</pre></div>
</div>
<p>The model also works on pandas DataFrames as expected:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">prediction_df</span><span class="p">[[</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;x2&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">())</span>
<span class="go">array([[1.35555142]])</span>
</pre></div>
</div>
</dd></dl>

</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="pyspark.pandas.mlflow.PythonModelWrapper.html" title="previous page">pyspark.pandas.mlflow.PythonModelWrapper</a>
    <a class='right-next' id="next-link" href="../extensions.html" title="next page">Extensions</a>

              </div>
              
          </main>
          

      </div>
    </div>

    
  <script src="../../../_static/js/index.3da636dd464baa7582d2.js"></script>


    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright .<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.4.<br/>
    </p>
  </div>
</footer>
  </body>
</html>